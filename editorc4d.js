var express = require('express')
var app = express()
const http = require('http').Server(app);
const io = require('socket.io')(http);
const port = process.env.PORT || 3000;
const fs = require('fs');
var cookieParser = require('cookie-parser');
var favicon = require('serve-favicon')
var session = require('express-session')
app.use(cookieParser());
app.use(express.json({limit: '50mb'}));
app.use(express.urlencoded({limit: '50mb', extended: true}));
app.use(favicon(__dirname + '/' +'EditorC4D.ico'))
app.get('/node_modules/socket.io/client-dist/socket.io.js.map',  (req, res)=>{res.sendFile(__dirname + '/node_modules/socket.io/client-dist/socket.io.js.map');});
app.get('/node_modules/socket.io/client-dist/socket.io.js',  (req, res)=>{res.sendFile(__dirname + '/node_modules/socket.io/client-dist/socket.io.js');});
app.get('/',         (req, res)=>{res.send(meet4d(req));});
function meet4d(req) {
	var usuarios = io.engine.clientsCount;
	var sesionusuario =new Date().toISOString().replace(/T/, '').replace(/Z/, '').replace(/-/g, '').replace(/:/g, '').replace(/\./, '');
	var puntos="255,448 255,399 255,352 256,304 256,272 256,240 256,204 256,160 209,161 161,174 133,208 126,256 133,208 161,174 209,161 256,160 303,163 350,176 379,205 385,256 379,205 350,176 303,163 256,160 256,111 256,64 208,68 160,112 135,160 128,208 126,256 132,303 150,352 177,399 208,425 255,448 304,424 334,398 366,352 380,304 385,256 384,208 376,160 352,112 303,69 256,64";
	var estilo="fill: none; stroke: #0000FF; stroke-width: 1; stroke-linecap: round;stroke-linejoin: round;";
	var msg = sesionusuario +'|'+ puntos +'|' + estilo +'|' + usuarios;
	var vector4d={pid: sesionusuario, ptos: puntos ,sty: estilo};
let rta='<html lang="es" xmlns="http://www.w3.org/1999/xhtml"><head><title>EditorC4D</title><!--Obra : EditorC4D : Software para ilustrar en la Web, Autor: Jorge Julian Sanchez Velez, DNDA: Registro nacional de Derechos de autor Libro 13 Tomo 32 Partida 433 20120320 --><meta name="Autor" content="JULI4"/><meta name="Latitud"  content="6.2529001235962"/><meta name="Longitud" content="-75.564598083496"/><meta name="Altitud" content="1600.00"/><meta name="Instante" content="2022/03/15_11:27:00"/>        <meta name="Email" content="jorgejuliasanchez@gmail.com"/><meta name="keywords" content="Editor SVG Cuarta Dimension"/><meta name="description" content="SocioSistema de ilustracion vectorial"/><meta http-equiv="Expires" content="Tue, 25 Abr 1990 09:30:00 -0700"/><meta http-equiv="Content-Type" content="text/html;charset=utf-8"/><meta http-equiv="encoding" content="utf-8"/><link rel="shortcut icon" href="EditorC4D.ico"/>';
rta=rta +'<script src="/node_modules/socket.io/client-dist/socket.io.js"></script>';
rta=rta +'<style>.rotado{transform: rotateY(180deg); -webkit-transform:rotateY(180deg); -moz-transform:rotateY(180deg);}polyline {stroke-linecap: round; stroke-linejoin: round;} .borde333 {fill: none; stroke: black;stroke-width: 0.333;} .borde1 {fill: none; stroke: black; stroke-width: 1;} .base {fill: none; stroke: black; stroke-width: 1; } .flecha { fill: none; stroke: black; stroke-width: 1; } .azul { fill: blue; stroke: blue; stroke-width: 1; } .verde { fill: green; stroke: green; stroke-width: 1; } .verde1 { fill: none; stroke: green; stroke-width: 1; } .lima { fill: lime; stroke: lime; stroke-width: 1; } .negro { fill: black; stroke: black; stroke-width: 1; } .blanco { fill: white; stroke: white; stroke-width: 1; } .nada { fill: none; stroke: black; stroke-width: 1; } .vidrio { fill: none; stroke: black; stroke-width: 1; } .chupa { fill: blue; stroke: blue; stroke-width: 1; } .plata { fill: silver; stroke: rgb(128,128,128); stroke-width: 1; } .boton { position:absolute; background-color: #d7d7d7; cursor: pointer; cursor: hand; -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px; width: 64px; height: 64px; } .boton:hover { background-color: rgb(128,128,128); } .bactivo { position: absolute; background-color: yellow; cursor: pointer; cursor: hand; -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px; width: 64px; height: 64px; }</style></head>';
rta=rta +'<body style="margin: 0; padding: 0;"><video id="video" class="rotado" style="background: #D0D0D0 ;width:512px;height:384px;position: absolute; left: 0px; top: 64px;" playsinline autoplay ></video><canvas id="myCanvas4D" class="rotado" width="384px" height="384px" style="display: none; width:384px;height:384px;position:absolute;left: 64px;right: 0;top: 64px;"></canvas><svg id="panel4d"  class="rotado" viewBox="0 0 512 512" style="position: absolute; left: 0px;   top: 0px; width: 512px; height: 512px;">    <defs><linearGradient id="grado" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color: white;stop-opacity:1" /><stop offset="100%" style="stop-color: rgb(128,128,128);stop-opacity:1" /></linearGradient><linearGradient id="gradn" gradientTransform="rotate(90)" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color: white;stop-opacity:1" /><stop offset="100%" style="stop-color: rgb(128,128,128);stop-opacity:1" /></linearGradient><linearGradient id="grads"  gradientTransform="rotate(90)" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:rgb(128,128,128);stop-opacity:1" /><stop offset="100%" style="stop-color: white;stop-opacity:1" /></linearGradient><linearGradient id="grade" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color: rgb(128,128,128);stop-opacity:1" /><stop offset="100%" style="stop-color: white;stop-opacity:1" /></linearGradient></defs></svg>';
rta=rta +'<canvas id="canvas64" class="boton rotado" onclick="foto4d()" width="64px" height="64px" style="left: 512px; top: 0px;width:  64px;height:  64px;"></canvas><svg id="b2" onclick="poly4d()" class="boton" viewBox="0 0 64 64" style="top:  64px; left: 512px;"><polyline class="negro" points="64,0 60,4 60,59 64,64 59,60 4,60 0,64 64,64 64,0"></polyline><polyline id="pol" class="blanco" points="4,4 59,4 59,59 4,59 4,4"></polyline><polyline points="14,22 33,12 50,32 40,50 22,46 14,22" style="fill: none; stroke: black; stroke-width: 1;"></polyline><polyline points="12,20 15,20 15,24 12,24  12,20" style="fill: none; stroke: blue; stroke-width: 1;"></polyline></svg><svg id="b3" onclick="colorpic4d()" class="boton" viewBox="0 0 64 64" style="top: 128px; left: 512px;"><polyline class="negro" points="64,0 60,4 60,59 64,64 59,60 4,60 0,64 64,64 64,0"></polyline><polyline class="blanco" points="4,4 59,4 59,59 4,59 4,4"></polyline><polyline id="pat" class="verde" points="14,14 50,14 50,50 14,50 14,14"></polyline><polyline class="vidrio" points="32,22,32,20,39,13,41,15,34,22,32,22"></polyline><polyline class="chupa" points="45,9 45,12 43,14 43,16 42,17 37,12 38,11 39,11 42,8 45,9 "></polyline></svg><svg id="b4" onclick="colorear4d()" class="boton" viewBox="0 0 64 64" style="top: 192px; left: 512px;"><polyline class="negro" points="64,0 60,4 60,59 64,64 59,60 4,60 0,64 64,64 64,0"></polyline><polyline class="blanco" points="4,4 59,4 59,59 4,59 4,4"></polyline><polyline class="verde" points="16,16 26,16 26,26 16,26 16,16"></polyline><polyline class="nada" points="34,32 44,32 44,42 34,42 34,32"></polyline></svg><svg id="b5" onclick="atras4d()" class="boton" viewBox="0 0 64 64" style="top: 256px; left: 512px;"><polyline class="negro" points="64,0 60,4 60,59 64,64 59,60 4,60 0,64 64,64 64,0"></polyline><polyline class="blanco" points="4,4 59,4 59,59 4,59 4,4"></polyline><polyline class="verde" points="16,16 52,16 52,52 16,52 16,16"></polyline><polyline class="plata" points="12,12 48,12 48,48 12,48 12,12"></polyline></svg><svg id="b6" onclick="abrir4d()" class="boton" viewBox="0 0 64 64" style="top: 320px; left: 512px;"><polyline class="negro" points="64,0 60,4 60,59 64,64 59,60 4,60 0,64 64,64 64,0"></polyline><polyline class="blanco" points="4,4 59,4 59,59 4,59 4,4"></polyline><polyline class="verde" points="14,50 50,50 50,56 14,56 14,50"></polyline><polyline class="verde" points="32,6 50,26 40,26 40,46 24,46 24,26 14,26 32,6"></polyline></svg><svg id="b7" onclick="salv4d()" class="boton" viewBox="0 0 64 64" style="top: 384px;left: 512px;"><polyline class="negro" points="64,0 60,4 60,59 64,64 59,60 4,60 0,64 64,64 64,0"></polyline><polyline class="blanco" points="4,4 59,4 59,59 4,59 4,4"></polyline><polyline class="verde" points="14,50 50,50 50,56 14,56 14,50"></polyline><polyline class="verde" points="32,46 14,28 24,28 24,6 40,6 40,28 50,28 32,46"></polyline></svg><svg id="b8" onclick="textear4d()"  class="boton" viewBox="0 0 64 64" style="top: 448px; left: 512px;"><polyline class="negro" points="64,0 60,4 60,59 64,64 59,60 4,60 0,64 64,64 64,0"></polyline><polyline class="blanco" points="4,4 59,4 59,59 4,59 4,4"></polyline><text shape-rendering="geometricPrecision" x="14" y="50" style="fill: green; stroke: gray;font-family:monospace;font-size:57px">A</text></svg><div id="zona4d" style="position: absolute; display: block; left: 0px; top: 512px;width: 576px;height: 64px;"><input id="incolorlleno" type="color" value="#FFFFFF" onchange="actualiza4d()" /><input id="chklleno"  type="checkbox" onclick="actualiza4d()" ><input id="incolorborde" type="color" onchange="actualiza4d()" /><input id="chkborde"  type="checkbox" onclick="actualiza4d()" checked><input id="textoin" name="textoin" type="text" value="" onchange="actualiza4d()" placeholder="Texto" size="20" /><select id="tipotexto" onchange="actualiza4d()"><option id="Arial">Arial</option><option id="monospace">monospace</option><option id="Verdana">Verdana</option><option id="Helvetica">Helvetica</option><option id="Tahoma">Tahoma</option><option id="Trebuchet MS">Trebuchet MS</option><option id="Times_New_Roman">Times New Roman</option><option id="Georgia">Georgia</option><option id="Garamond">Garamond</option><option id="Courier_New">Courier New</option><option id="Brush_Script_MT">Brush Script MT</option></select><select id="fuentesize" onchange="actualiza4d()"><option id="p2px">2px</option><option id="p4px">4px</option><option id="p8px">8px</option><option id="p10px">10px</option><option id="p12px" selected>12px</option><option id="p16px">16px</option><option id="p20px">20px</option><option id="p24px">24px</option><option id="p30px">30px</option><option id="p32px">32px</option><option id="p40px">40px</option><option id="p50px">40px</option><option id="p60px">60px</option><option id="p60px">64px</option><option id="p80px">92px</option></select></div>';
rta=rta +'<script>var canvas1=document.getElementById("myCanvas4D"); var canvas4d = canvas1.getContext("2d"); var canvas2 = document.getElementById("canvas64");var canvas24d = canvas2.getContext("2d");const video = document.getElementById("video");const constraints = { audio: false,video: { width: { ideal: 512 }, height: { ideal: 384 } }};var localstream, elId;videoON(); async function videoON() { try { const stream = await navigator.mediaDevices.getUserMedia(constraints); exitosa(stream);} catch (e) {                 alert(`navigator.getUserMedia error:${e.toString()}`);}} function exitosa(stream) { window.stream = stream; video.srcObject = stream; localstream = stream;}; function videoOFF(){ video.pause();  video.currentTime = 0; localstream.getTracks()[0].stop(); } ';            
rta=rta +'tapas(); malla4d();text4d("__aplicacion", 96, 56, "fill: #000000; stroke:  #FFFFFF ;font-family: Arial;font-size: 60px;","EditorC4D"); function tapas()  {var pts= "0,0 64,64 64,448 0,512 0,0";poli4d("__tapao", pts, "fill: url(#grado); stroke: black; stroke-width: 0.3; stroke-linecap: round;stroke-linejoin: round;") ;pts= "512,0 448,64 448,448 512,512 512,512";poli4d("__tapae", pts, "fill: url(#grade); stroke: black; stroke-width: 0.3; stroke-linecap: round;stroke-linejoin: round;") ;pts= "0,0 512,0 448,64 64,64 0,0";poli4d("__tapan", pts, "fill: url(#gradn); stroke: black; stroke-width: 0.3; stroke-linecap: round;stroke-linejoin: round;") ;pts= "0,512 64,448 448,448 512,512 0,512";poli4d("__tapas", pts, "fill: url(#grads); stroke: black; stroke-width: 0.3; stroke-linecap: round;stroke-linejoin: round;") ; }function malla4d(){var lado=512, partes=8, p4d=8; var cara=lado/partes, prop=lado/p4d, p1=(lado-2*prop)/partes, p2=(lado-prop);for(var i= 0; i <= partes ;i=i+1){var propi=(prop+i*p1),pi=cara*i;pts= propi +","+prop + " "+ propi+ ","+p2;poli4d("__mallax"+i, pts, "fill: none; stroke: black; stroke-width: 0.33; stroke-linecap: round;stroke-linejoin: round;") ;pts= prop+","+ propi + " "+p2+","+propi;poli4d("__mallay"+i, pts, "fill: none; stroke: black; stroke-width: 0.33; stroke-linecap: round;stroke-linejoin: round;") ;pts= pi +",0 "+propi+","+prop;poli4d("__mallan"+i, pts, "fill: none; stroke: black; stroke-width: 1; stroke-linecap: round;stroke-linejoin: round;") ;pts= pi +",512 "+propi+","+p2;poli4d("__mallas"+i, pts, "fill: none; stroke: black; stroke-width: 1; stroke-linecap: round;stroke-linejoin: round;") ;pts= "512,"+ pi +" "+p2 +","+ propi;poli4d("__mallae"+i, pts, "fill: none; stroke: black; stroke-width: 1; stroke-linecap: round;stroke-linejoin: round;") ;pts= "0,"+ pi +" "+prop+","+ propi;poli4d("__mallao"+i, pts, "fill: none; stroke: black; stroke-width: 1; stroke-linecap: round;stroke-linejoin: round;") ;} }   ';        
rta=rta +'var t=0; var startTime, endTime; startTime = new Date();function pulso4d(){try {var inidate = new Date();instante = inidate.getFullYear() + "/" + ("0" + (inidate.getMonth() + 1)).slice(-2) + "/" + ("0" + inidate.getDate()).slice(-2) +" " + ("0" + inidate.getHours()).slice(-2) +":" + ("0" + inidate.getMinutes()).slice(-2) +":" + ("0" + inidate.getSeconds()).slice(-2);canvas24d.drawImage(video, 64, 0, 384, 384, 0, 0, 64, 64);var findate = new Date(); instante = findate.getFullYear() + "/" + ("0" + (findate.getMonth() + 1)).slice(-2) + "/" + ("0" + findate.getDate()).slice(-2) +" " + ("0" + findate.getHours()).slice(-2) +":" + ("0" + findate.getMinutes()).slice(-2) +":" + ("0" + findate.getSeconds()).slice(-2);if(findate-inidate){var fps=parseInt(1000/(findate-inidate));if (t >= 1000) {endTime = new Date();var timeDiff = endTime - startTime; timeDiff /= 1000;var seconds = Math.round(timeDiff);t=0;} else {t=t+19;pruta= "0,511 " + parseInt(t/2) + ",511" + " " + parseInt(t/2) + ",512 0,512";	          		poli4d("guia", pruta,"fill: #8a0303; stroke: #8a0303; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;");}}elId = window.requestAnimationFrame(pulso4d);} catch (e) {alert(`Error en pulso4d :${e.toString()}`)}} pulso4d();'; 
rta=rta +'const socket = io();socket.on("poli", function(msg){var array = msg.split("|");poli4d(array[0],array[1],array[2]);});socket.emit("poli","' + msg + '");';
rta=rta +'function foto4d(){ canvas4d.drawImage(video,64,0,384,384,0, 0, 384, 384); document.getElementById("myCanvas4D").style.display = "block";videoOFF();}';
rta=rta +'function poli4d(pid, pts, sty) {var o4d; if (document.getElementById(pid)) {o4d = document.getElementById(pid);} else {o4d = document.createElementNS("http://www.w3.org/2000/svg", "polyline");o4d.setAttribute("shape-rendering", "geometricPrecision"); o4d.setAttribute("id", pid);} o4d.setAttribute("points", pts);if (sty !== " ") {o4d.setAttribute("style", sty);} if (!document.getElementById(pid)) {document.getElementById("panel4d").appendChild(o4d); } }function text4d(pid, px, py, sty, txt) {var o4d;if (document.getElementById(pid)) {o4d = document.getElementById(pid);} else {o4d = document.createElementNS("http://www.w3.org/2000/svg", "text");o4d.setAttribute("shape-rendering", "geometricPrecision");o4d.setAttribute("id", pid);}o4d.setAttribute("x", px);o4d.setAttribute("y", py);if (sty !== " ") {o4d.setAttribute("style", sty);}o4d.textContent = txt;if (!document.getElementById(pid)) {document.getElementById("panel4d").appendChild(o4d);}}</script>';
rta=rta +'</body></html>';  
return rta;
}
io.on('connection', (socket) => {socket.on('poli', msg => {io.emit('poli', msg);});});
http.listen(port, () => {  console.log(`Ejecutando EditorC4D.js en el puerto ${port}`);});